<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>欠勤連絡 管理ページ（閲覧・CSV）</title>
  <style>
    body{font-family:system-ui,-apple-system,sans-serif;background:#f5f5f5;padding:20px}
    .card{max-width:1050px;margin:auto;background:#fff;padding:18px;border-radius:10px}
    h2{margin:0 0 12px;text-align:center}
    label{display:block;margin-top:10px;font-weight:600}
    input,button{width:100%;padding:10px;margin-top:6px;font-size:16px;box-sizing:border-box}
    button{background:#0070f3;color:#fff;border:none;border-radius:6px;cursor:pointer;margin-top:12px}
    button:disabled{background:#999;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{border:1px solid #ddd;padding:8px;font-size:14px;vertical-align:top}
    th{background:#fafafa}
    #msg{margin-top:10px;font-weight:700;text-align:center}
    .muted{color:#666;font-size:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{font-size:12px;background:#f0f0f0;padding:6px 10px;border-radius:999px}
  </style>
</head>
<body>
  <div class="card">
    <div class="topbar">
      <h2>欠勤連絡 管理ページ（閲覧・CSV）</h2>
      <div class="pill">管理者のみ共有（URL秘匿）</div>
    </div>

    <div class="row">
      <label>開始日（任意）
        <input id="startDate" type="date">
      </label>
      <label>終了日（任意）
        <input id="endDate" type="date">
      </label>
    </div>

    <div class="actions">
      <button id="searchBtn">表示（検索）</button>
      <button id="csvBtn" style="background:#2b7;">CSVダウンロード</button>
    </div>

    <div id="msg"></div>
    <div class="muted">※ 日付は日本時間（JST）で指定。未指定なら全件対象。</div>

    <table id="tbl" style="display:none;">
      <thead>
        <tr>
          <th>送信日時</th>
          <th>名前</th>
          <th>所属</th>
          <th>種別</th>
          <th>コメント</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

 <script>
  const SUPABASE_URL = "https://ffpuqxyufqugotivqkgi.supabase.co";
  const SUPABASE_KEY = "sb_publishable_5247tSd7ptdrSv6y0972rA_zm_6t99i";

  const msg = (t)=>document.getElementById("msg").innerText=t||"";
  const showTable = (on)=>document.getElementById("tbl").style.display = on ? "table" : "none";

  function toJstStartISO(d){ return `${d}T00:00:00+09:00`; }
  function toJstEndISO(d){ return `${d}T23:59:59+09:00`; }

  function esc(v){
    if(v==null) return "";
    return String(v).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function csvEscape(v){
    if(v==null) return "";
    const s=String(v);
    return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
  }

 async function fetchRows(){
  const start = document.getElementById("startDate").value; // YYYY-MM-DD
  const end = document.getElementById("endDate").value;

  const params = new URLSearchParams();
  params.set("select", "created_at_jst,name,department,type,comment");
  params.set("order", "created_at_jst.asc");

  // created_at_jst は "timestamp"（タイムゾーン無し）なので、JSTの文字列で絞り込む
  if (start) params.append("created_at_jst", `gte.${start}T00:00:00`);
  if (end)   params.append("created_at_jst", `lte.${end}T23:59:59`);

  const url = `${SUPABASE_URL}/rest/v1/absence_reports?${params.toString()}`;

  const res = await fetch(url, {
    method: "GET",
    headers: {
      "apikey": SUPABASE_KEY,
      "Authorization": `Bearer ${SUPABASE_KEY}`,
      "Accept": "application/json"
    }
  });

  if (!res.ok) {
    const t = await res.text();
    throw new Error(`HTTP ${res.status}: ${t}`);
  }
  return await res.json();
}


    if (!res.ok) {
      const t = await res.text();
      throw new Error(`HTTP ${res.status}: ${t}`);
    }
    return await res.json();
  }

  function renderTable(rows){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatJst(r.created_at)}</td>
        <td>${esc(r.name)}</td>
        <td>${esc(r.department)}</td>
        <td>${esc(r.type)}</td>
        <td>${esc(r.comment)}</td>`;
      tbody.appendChild(tr);
    });
    showTable(rows.length>0);
  }
function formatJst(isoString){
  if(!isoString) return "";
  const d = new Date(isoString); // 自動で日本時間

  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  const hh = String(d.getHours()).padStart(2, "0");
  const mm = String(d.getMinutes()).padStart(2, "0");
  const ss = String(d.getSeconds()).padStart(2, "0");

  return `${y}-${m}-${day} ${hh}:${mm}:${ss}`;
}



function downloadCSV(rows){
  if(!rows.length){ msg("対象データがありません（0件）"); return; }

  // CSVのヘッダー（1列目を datetime にする）
  const headers = ["datetime","name","department","type","comment"];

  const lines = [
    headers.join(","),
    ...rows.map(r => [
      csvEscape(formatJst(r.created_at)), // ★ここがJST整形
      csvEscape(r.name),
      csvEscape(r.department),
      csvEscape(r.type),
      csvEscape(r.comment)
    ].join(","))
  ];

  // ★Excel文字化け対策（BOM付きUTF-8）
  const bom = "\uFEFF";
  const blob = new Blob([bom + lines.join("\n")], { type:"text/csv;charset=utf-8;" });

  const start = document.getElementById("startDate").value || "all";
  const end = document.getElementById("endDate").value || "all";

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `absence_reports_${start}_${end}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function formatJst(isoString){
  if(!isoString) return "";
  const d = new Date(isoString);

  // JSTに変換
  const jst = new Date(d.getTime() + 9 * 60 * 60 * 1000);

  const y = jst.getFullYear();
  const m = String(jst.getMonth() + 1).padStart(2, "0");
  const day = String(jst.getDate()).padStart(2, "0");
  const hh = String(jst.getHours()).padStart(2, "0");
  const mm = String(jst.getMinutes()).padStart(2, "0");

  return `${y}-${m}-${day} ${hh}:${mm}`;
}

  document.getElementById("searchBtn").onclick = async ()=>{
    msg("取得中…");
    try{
      const rows = await fetchRows();
      renderTable(rows);
      msg(rows.length ? `表示しました（${rows.length}件）` : "0件です");
    }catch(e){
      msg("失敗: " + (e.message || e));
      showTable(false);
    }
  };

  document.getElementById("csvBtn").onclick = async ()=>{
    msg("CSV作成中…");
    try{
      const rows = await fetchRows();
      downloadCSV(rows);
      msg("CSVをダウンロードしました");
    }catch(e){
      msg("失敗: " + (e.message || e));
    }
  };
</script>
</body>
</html>






